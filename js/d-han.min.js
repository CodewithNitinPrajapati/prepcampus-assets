// Function to handle dropdown toggle
function handleDropdownToggle() {
  var dropdown = document.getElementsByClassName("dropdown-btn");

  for (let i = 0; i < dropdown.length; i++) {
    dropdown[i].addEventListener("click", function () {
      this.classList.toggle("active");
      var dropdownContent = this.nextElementSibling;
      dropdownContent.style.display =
        dropdownContent.style.display === "block" ? "none" : "block";
    });
  }
}

// Function to handle active links and expand dropdown based on URL
function updateActiveLinks() {
  const currentUrl = window.location.href;
  const sidebarLinks = document.querySelectorAll(".sidenav a");

  sidebarLinks.forEach(link => {
    const linkUrl = new URL(link.href, window.location.origin).pathname;
    const currentPath = window.location.pathname;

    if (currentPath === linkUrl) {
      link.classList.add("active");

      // Expand the parent dropdown if it exists
      const dropdownContainer = link.closest(".dropdown-container");
      if (dropdownContainer) {
        dropdownContainer.style.display = "block";
        const dropdownButton = dropdownContainer.previousElementSibling;
        if (dropdownButton) {
          dropdownButton.classList.add("active");
        }
      }
    } else {
      link.classList.remove("active");
    }
  });
}

// Function to show the selected course's topics
function showTopics(courseId) {
  document.querySelectorAll(".course-topics").forEach(topic => {
    topic.style.display = "none";
  });

  var courseTopics = document.getElementById(courseId + "-topics");
  if (courseTopics) {
    courseTopics.style.display = "block";
  }
}

// Run when the page loads
document.addEventListener("DOMContentLoaded", function () {
  handleDropdownToggle();
  updateActiveLinks();

  // Check URL for 'topic' parameter
  const urlParams = new URLSearchParams(window.location.search);
  const topic = urlParams.get("topic");
  showTopics(topic ? topic : "python");
});

// Handle updates to active links via fetch or XMLHttpRequest
const updateActiveLinkFromRequest = (requestedUrl) => {
  const sidebarLinks = document.querySelectorAll(".sidenav a");
  const requestedPath = new URL(requestedUrl, window.location.origin).pathname;

  sidebarLinks.forEach(link => {
    const linkPath = new URL(link.href, window.location.origin).pathname;

    link.classList.remove("active");
    const dropdownContainer = link.closest(".dropdown-container");
    if (dropdownContainer) {
      dropdownContainer.previousElementSibling?.classList.remove("active");
    }

    if (requestedPath === linkPath) {
      link.classList.add("active");
      if (dropdownContainer) {
        dropdownContainer.style.display = "block";
        dropdownContainer.previousElementSibling?.classList.add("active");
      }
    }
  });
};

// Intercept fetch API to update active link
const originalFetch = window.fetch;
window.fetch = function (...args) {
  return originalFetch(...args).then(response => {
    updateActiveLinkFromRequest(args[0]);
    return response;
  });
};

// Intercept XMLHttpRequest to update active link
const originalOpen = XMLHttpRequest.prototype.open;
XMLHttpRequest.prototype.open = function (method, url, ...args) {
  updateActiveLinkFromRequest(url);
  return originalOpen.call(this, method, url, ...args);
};
