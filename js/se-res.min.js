(function () {
  const inp = document.getElementById('searchInput');
  const box = document.getElementById('searchResults');
  if (!inp || !box) return;

  let t;
  async function run() {
    const q = inp.value.trim();
    if (!q) {
      box.style.display = 'none';
      return;
    }
    try {
      const res = await fetch('/feeds/posts/default?alt=json&q=' + encodeURIComponent(q) + '&max-results=500');
      const data = await res.json();
      const entries = (data.feed && data.feed.entry) || [];
      let html = '';

      entries.forEach(e => {
        const title = e.title.$t;
        const link = (e.link.find(l => l.rel === 'alternate') || {}).href || '#';
        const raw = (e.summary && e.summary.$t) || '';
        const snippet = raw.replace(/<[^>]+>/g, '').slice(0, 90);
        html += `<a href="${link}"><strong>${title}</strong><br><small>${snippet}</small></a>`;
      });

      box.innerHTML = html || '<div>No results found</div>';
      box.style.display = 'block';
    } catch (err) {
      console.error(err);
    }
  }

  inp.addEventListener('input', () => {
    clearTimeout(t);
    t = setTimeout(run, 250);
  });

  document.addEventListener('click', e => {
    if (!box.contains(e.target) && e.target !== inp) box.style.display = 'none';
  });
})();
